// universal.min.js - Updated version of your working script
(function() {
    // Get webhook URL from data attribute or fallback
    var scripts = document.querySelectorAll('script[data-webhook]');
    var WEBHOOK_URL = scripts.length > 0 ? 
        scripts[scripts.length - 1].getAttribute('data-webhook') : 
        'https://n8n.wynnatlove.com/webhook/ff7d39ac-2ac9-4ba3-a6a8-fabc159c44c1';
    
    var processedSubmissions = new Set();
    
    // Browser-compatible closest() polyfill
    function findClosest(element, selector) {
        if (element.closest) {
            return element.closest(selector);
        }
        
        var current = element;
        while (current && current !== document) {
            if (current.matches && current.matches(selector)) {
                return current;
            }
            if (current.tagName && selector.includes(current.tagName.toLowerCase())) {
                return current;
            }
            if (current.className && selector.includes('modal') && current.className.toLowerCase().includes('modal')) {
                return current;
            }
            if (current.className && selector.includes('popup') && current.className.toLowerCase().includes('popup')) {
                return current;
            }
            current = current.parentElement;
        }
        return null;
    }
    
    function getAdTrackingParams() {
        var params = {};
        var urlParams = new URLSearchParams(window.location.search);
        
        // Google Ads tracking
        var googleParams = ['gclid', 'gclsrc', 'gbraid', 'wbraid', 'dclid'];
        googleParams.forEach(function(param) {
            var value = urlParams.get(param);
            if (value) params[param] = value;
        });
        
        // Facebook/Meta tracking
        var fbParams = ['fbclid', 'fbadid', 'fb_action_ids', 'fb_action_types', 'fb_source'];
        fbParams.forEach(function(param) {
            var value = urlParams.get(param);
            if (value) params[param] = value;
        });
        
        // UTM parameters
        var utmParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'utm_id'];
        utmParams.forEach(function(param) {
            var value = urlParams.get(param);
            if (value) params[param] = value;
        });
        
        // Other major platforms
        var otherParams = [
            'ttclid', 'tt_medium', 'tt_content', // TikTok
            'ScCid', 'snapchat_click_id', // Snapchat
            'epik', 'pinterest_ct', // Pinterest
            'li_fat_id', 'linkedin_click_id', // LinkedIn
            'twclid', 'twitter_click_id', // Twitter
            'msclkid', 'ms_click_id', // Microsoft/Bing
            'affiliate_id', 'aff_id', 'ref', 'source', 'campaign', 'ad_id'
        ];
        otherParams.forEach(function(param) {
            var value = urlParams.get(param);
            if (value) params[param] = value;
        });
        
        return params;
    }
    
    function captureFormData(container) {
        var data = {};
        var searchContainer = container || document;
        var inputs = searchContainer.querySelectorAll('input, select, textarea');
        
        inputs.forEach(function(input) {
            if (input.value && input.value.trim() !== '' && !input.disabled) {
                var key = input.name || input.id || input.type || 'field';
                
                if (input.type === 'checkbox' || input.type === 'radio') {
                    if (input.checked) {
                        data[key] = input.value || 'checked';
                    }
                } else if (input.tagName === 'SELECT') {
                    var selectedOption = input.options[input.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        data[key] = selectedOption.value;
                    }
                } else if (input.type !== 'submit' && input.type !== 'button') {
                    data[key] = input.value;
                }
            }
        });
        
        // Add ad tracking parameters
        var adTracking = getAdTrackingParams();
        if (Object.keys(adTracking).length > 0) {
            data._tracking = adTracking;
        }
        
        // Add basic metadata
        data._meta = {
            page_url: location.href,
            timestamp: Date.now()
        };
        
        return data;
    }
    
    function findRelevantContainer(element) {
        var container = findClosest(element, 'form');
        if (container) return container;
        
        var parent = element.parentElement;
        while (parent && parent !== document.body) {
            var inputsInParent = parent.querySelectorAll('input, select, textarea');
            if (inputsInParent.length > 0) {
                return parent;
            }
            parent = parent.parentElement;
        }
        
        return document;
    }
    
    function sendToWebhook(data, context) {
        if (!data || Object.keys(data).length === 0) {
            return false;
        }
        
        // Create unique submission identifier
        var formData = {};
        var hasActualFormData = false;
        
        Object.keys(data).forEach(function(key) {
            if (key !== '_tracking' && key !== '_meta') {
                formData[key] = data[key];
                hasActualFormData = true;
            }
        });
        
        if (!hasActualFormData) {
            return false;
        }
        
        var submissionId = JSON.stringify(formData) + location.href;
        var now = Date.now();
        var recentSubmissionKey = submissionId + '_recent';
        var lastSubmissionTime = window[recentSubmissionKey] || 0;
        
        if (processedSubmissions.has(submissionId) || (now - lastSubmissionTime < 5000)) {
            return false;
        }
        
        processedSubmissions.add(submissionId);
        window[recentSubmissionKey] = now;
        
        var payload = {
            d: data,
            u: location.href,
            t: Date.now(),
            context: context
        };
        
        if (navigator.sendBeacon) {
            return navigator.sendBeacon(WEBHOOK_URL, JSON.stringify(payload));
        } else {
            fetch(WEBHOOK_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: {'Content-Type': 'application/json'},
                keepalive: true
            }).catch(function() {});
            return true;
        }
    }
    
    // Handle form submissions
    document.addEventListener('submit', function(e) {
        var container = findRelevantContainer(e.target);
        var data = captureFormData(container);
        sendToWebhook(data, 'form_submit');
    });
    
    // Handle button clicks
    document.addEventListener('click', function(e) {
        var target = e.target;
        var isSubmitElement = (
            target.type === 'submit' ||
            (target.tagName === 'BUTTON' && (!target.type || target.type === 'submit')) ||
            /submit|send|join|sign|register|subscribe|reserve/i.test(target.textContent || target.value)
        );
        
        if (isSubmitElement) {
            var container = findRelevantContainer(target);
            var data = captureFormData(container);
            
            var hasFormFields = false;
            Object.keys(data).forEach(function(key) {
                if (key !== '_tracking' && key !== '_meta') {
                    hasFormFields = true;
                }
            });
            
            if (hasFormFields) {
                sendToWebhook(data, 'form_click');
            }
        }
    });
    
    // Manual test function
    window.testLeadCapture = function() {
        var data = captureFormData();
        return sendToWebhook(data, 'manual_test');
    };
})();
